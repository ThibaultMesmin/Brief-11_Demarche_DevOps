name: Release

on:
  push:
    branches:
      - main

jobs:
  get-version:
    uses: shiipou/github-actions/.github/workflows/get-version.yml@main
    with:
      release-branches: '^(main)$'
    
  build:
   name: Spring build
   runs-on: ubuntu-latest
   # si get-version voit un commit qui permet une release (montée de version), il fait le build, sinon fait pas le build
   if: ${{ needs.get-version.outputs.will-release == 'true' }}
   # on doit lui dire qu'on a besoin de get-version pour le build (récupère que les sorties du job)
   needs: 
     - get-version

   steps:
      - name: Checkout Repository
        uses: actions/checkout@v4

      - name: setup rust
        uses: rust-marker/marker@v0.5

      - name: Install Rust toolchain
        uses: dtolnay/rust-toolchain@v1
        with:
          toolchain: stable
          default: true 

  release:
    name: Release
    runs-on: ubuntu-latest
    # récupère que les sorties du job get-version et build (outputs)
    needs:
      - get-version
      - build
      
    steps:
      - name: Install Trunk
        uses: mbround18/trunk-rs@v0.0.1
      - name: Download artifacts
        uses: actions/download-artifact@v4
        with:
          name: spring
          path: build/
      - name: Create Github Release
        env:
          VERSION: "${{ needs.get-version.outputs.version }}"
          REPO: "${{ github.repository }}"
          COMMIT: "${{ github.sha }}"
          GH_TOKEN: "${{ github.token }}"
        # $REPO = le repo sur lequel on veut que ça se fasse
        # $COMMIT = le commit en rapport au push (prend donc le bon commit et non le dernier effectué)
        # $VERSION = la version récupérée du get-version
        # GH_TOKEN = connu et généré par github
        run: |
          gh release create --repo $REPO --target $COMMIT $VERSION build/*
    
    
